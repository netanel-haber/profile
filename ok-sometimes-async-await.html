<DOCTYPE html>
  <html lang="en">
    <head>
      <meta charset="UTF-8" />
      <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <title>Concurrency</title>
      <link rel="icon" type="image/x-icon" href="/assets/favicon.ico" />
      <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16x16.png" />
      <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png" />
      <link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png" />
      <link rel="manifest" href="/site.webmanifest" />
      <link rel="stylesheet" href="index.css" />
    </head>

    <body>
      <main class="blog-main">
        <article>
          <h2 id="ok-sometimes-async-await">
            <a href="#ok-sometimes-async-await">Ok, Sometimes Async-Await</a>
          </h2>
          <p>
            Normally, I continue believing that the classic (well, ES6)
            <code class="">promise.then().catch().finally()</code> is nicer than
            using the newer ES17 <code class="">async-await</code> syntax,
            because of function composability<sup
              ><a
                aria-current="page"
                href="/ok-sometimes-async-await#user-content-fn-1"
                class="router-link-active router-link-exact-active"
                aria-describedby="footnote-label"
                data-footnote-ref=""
                id="user-content-fnref-1"
                >1</a
              ></sup
            >. There are 2 cases where I think
            <code class="">async-await</code> is neater, and one where it may
            perceivably come in handy:
          </p>
          <h3 id="_1-early-returnthrowing-errors">
            <a href="#_1-early-returnthrowing-errors"
              >1. Early Return/Throwing Errors</a
            >
          </h3>
          <pre
            class="language-ts shiki shiki-themes synthwave-84"
          ><code><span class="line" line="1"><span style="--shiki-default:#FEDE5D">async</span><span style="--shiki-default:#FEDE5D"> function</span><span style="--shiki-default:#36F9F6"> returnEarly</span><span style="--shiki-default:#BBBBBB">()</span><span style="--shiki-default:#FEDE5D">:</span><span style="--shiki-default:#FE4450"> Promise</span><span style="--shiki-default:#BBBBBB">&lt;</span><span style="--shiki-default:#FE4450">SomeType</span><span style="--shiki-default:#FEDE5D"> |</span><span style="--shiki-default:#FE4450"> undefined</span><span style="--shiki-default:#BBBBBB">&gt; {
    </span></span><span class="line" line="2"><span style="--shiki-default:#FEDE5D">  if</span><span style="--shiki-default:#BBBBBB"> (</span><span style="--shiki-default:#FF7EDB">someCondition</span><span style="--shiki-default:#BBBBBB">) </span><span style="--shiki-default:#FEDE5D">return</span><span style="--shiki-default:#BBBBBB">;
    </span></span><span class="line" line="3"><span style="--shiki-default:#FEDE5D">  await</span><span style="--shiki-default:#36F9F6"> networkRequest</span><span style="--shiki-default:#BBBBBB">();
    </span></span><span class="line" line="4"><span style="--shiki-default:#FEDE5D">  if</span><span style="--shiki-default:#BBBBBB"> (</span><span style="--shiki-default:#FF7EDB">someOtherCondition</span><span style="--shiki-default:#BBBBBB">) </span><span style="--shiki-default:#FEDE5D">return</span><span style="--shiki-default:#BBBBBB">;
    </span></span><span class="line" line="5"><span style="--shiki-default:#FEDE5D">  return</span><span style="--shiki-default:#FEDE5D"> await</span><span style="--shiki-default:#36F9F6"> someOtherNetworkRequest</span><span style="--shiki-default:#BBBBBB">();
    </span></span><span class="line" line="6"><span style="--shiki-default:#BBBBBB">}
    </span></span></code></pre>
          <p>
            This way, your function can return early concisely,
            <strong
              >but still always return a <code class="">Promise</code></strong
            >. This is because, all values returned from an
            <code class="">async function</code> are automatically wrapped in a
            <code class="">Promise</code> if they aren't already. The equivalent
            code is pretty ugly:
          </p>
          <pre
            class="language-ts shiki shiki-themes synthwave-84"
          ><code><span class="line" line="1"><span style="--shiki-default:#FEDE5D">function</span><span style="--shiki-default:#36F9F6"> returnEarly</span><span style="--shiki-default:#BBBBBB">()</span><span style="--shiki-default:#FEDE5D">:</span><span style="--shiki-default:#FE4450"> Promise</span><span style="--shiki-default:#BBBBBB">&lt;</span><span style="--shiki-default:#FE4450">SomeType</span><span style="--shiki-default:#FEDE5D"> |</span><span style="--shiki-default:#FE4450"> undefined</span><span style="--shiki-default:#BBBBBB">&gt; {
    </span></span><span class="line" line="2"><span style="--shiki-default:#FEDE5D">  if</span><span style="--shiki-default:#BBBBBB"> (</span><span style="--shiki-default:#FF7EDB">someCondition</span><span style="--shiki-default:#BBBBBB">) </span><span style="--shiki-default:#FEDE5D">return</span><span style="--shiki-default:#FE4450"> Promise</span><span style="--shiki-default:#BBBBBB">.</span><span style="--shiki-default:#36F9F6">resolve</span><span style="--shiki-default:#BBBBBB">();
    </span></span><span class="line" line="3"><span style="--shiki-default:#FEDE5D">  return</span><span style="--shiki-default:#36F9F6"> networkRequest</span><span style="--shiki-default:#BBBBBB">().</span><span style="--shiki-default:#36F9F6">then</span><span style="--shiki-default:#BBBBBB">(() </span><span style="--shiki-default:#FEDE5D">=&gt;</span><span style="--shiki-default:#BBBBBB"> {
    </span></span><span class="line" line="4"><span style="--shiki-default:#FEDE5D">    if</span><span style="--shiki-default:#BBBBBB"> (</span><span style="--shiki-default:#FF7EDB">someOtherCondition</span><span style="--shiki-default:#BBBBBB">) </span><span style="--shiki-default:#FEDE5D">return</span><span style="--shiki-default:#FE4450"> Promise</span><span style="--shiki-default:#BBBBBB">.</span><span style="--shiki-default:#36F9F6">resolve</span><span style="--shiki-default:#BBBBBB">();
    </span></span><span class="line" line="5"><span style="--shiki-default:#FEDE5D">    return</span><span style="--shiki-default:#36F9F6"> someOtherNetworkRequest</span><span style="--shiki-default:#BBBBBB">();
    </span></span><span class="line" line="6"><span style="--shiki-default:#BBBBBB">  });
    </span></span><span class="line" line="7"><span style="--shiki-default:#BBBBBB">}
    </span></span></code></pre>
          <h3 id="_2-promise-drilling">
            <a href="#_2-promise-drilling">2. Promise Drilling</a>
          </h3>
          <pre
            class="language-js shiki shiki-themes synthwave-84"
          ><code><span class="line" line="1"><span style="--shiki-default:#FEDE5D">async</span><span style="--shiki-default:#FEDE5D"> function</span><span style="--shiki-default:#36F9F6"> hotPotato</span><span style="--shiki-default:#BBBBBB">() {
    </span></span><span class="line" line="2"><span style="--shiki-default:#FEDE5D">  const</span><span style="--shiki-default:#FF7EDB"> a</span><span style="--shiki-default:#FFFFFFEE"> =</span><span style="--shiki-default:#FEDE5D"> await</span><span style="--shiki-default:#36F9F6"> networkRequestA</span><span style="--shiki-default:#BBBBBB">();
    </span></span><span class="line" line="3"><span style="--shiki-default:#FEDE5D">  const</span><span style="--shiki-default:#FF7EDB"> b</span><span style="--shiki-default:#FFFFFFEE"> =</span><span style="--shiki-default:#FEDE5D"> await</span><span style="--shiki-default:#36F9F6"> networkRequestB</span><span style="--shiki-default:#BBBBBB">(</span><span style="--shiki-default:#FF7EDB">a</span><span style="--shiki-default:#BBBBBB">);
    </span></span><span class="line" line="4"><span style="--shiki-default:#FEDE5D">  return</span><span style="--shiki-default:#FEDE5D"> await</span><span style="--shiki-default:#36F9F6"> networkRequestC</span><span style="--shiki-default:#BBBBBB">(</span><span style="--shiki-default:#FF7EDB">a</span><span style="--shiki-default:#BBBBBB">, </span><span style="--shiki-default:#FF7EDB">b</span><span style="--shiki-default:#BBBBBB">);
    </span></span><span class="line" line="5"><span style="--shiki-default:#BBBBBB">}
    </span></span></code></pre>
          <p>
            Sometimes, a computation requires a value several promises upstream.
            Using
            <code class="">async-await</code>, you see the entire function's
            scope trivially, so you don't need to drill down with the value.
          </p>
          <p>The equivalent code is ugly:</p>
          <pre
            class="language-js shiki shiki-themes synthwave-84"
          ><code><span class="line" line="1"><span style="--shiki-default:#FEDE5D">function</span><span style="--shiki-default:#36F9F6"> hotPotato</span><span style="--shiki-default:#BBBBBB">() {
    </span></span><span class="line" line="2"><span style="--shiki-default:#FEDE5D">  return</span><span style="--shiki-default:#36F9F6"> A</span><span style="--shiki-default:#BBBBBB">()
    </span></span><span class="line" line="3"><span style="--shiki-default:#BBBBBB">    .</span><span style="--shiki-default:#36F9F6">then</span><span style="--shiki-default:#BBBBBB">((</span><span style="--shiki-default:#FF7EDB;--shiki-default-font-style:italic">a</span><span style="--shiki-default:#BBBBBB">) </span><span style="--shiki-default:#FEDE5D">=&gt;</span><span style="--shiki-default:#36F9F6"> B</span><span style="--shiki-default:#BBBBBB">(</span><span style="--shiki-default:#FF7EDB">a</span><span style="--shiki-default:#BBBBBB">).</span><span style="--shiki-default:#36F9F6">then</span><span style="--shiki-default:#BBBBBB">((</span><span style="--shiki-default:#FF7EDB;--shiki-default-font-style:italic">b</span><span style="--shiki-default:#BBBBBB">) </span><span style="--shiki-default:#FEDE5D">=&gt;</span><span style="--shiki-default:#BBBBBB"> [</span><span style="--shiki-default:#FF7EDB">a</span><span style="--shiki-default:#BBBBBB">, </span><span style="--shiki-default:#FF7EDB">b</span><span style="--shiki-default:#BBBBBB">]))
    </span></span><span class="line" line="4"><span style="--shiki-default:#BBBBBB">    .</span><span style="--shiki-default:#36F9F6">then</span><span style="--shiki-default:#BBBBBB">(([</span><span style="--shiki-default:#FF7EDB;--shiki-default-font-style:italic">a</span><span style="--shiki-default:#BBBBBB">, </span><span style="--shiki-default:#FF7EDB;--shiki-default-font-style:italic">b</span><span style="--shiki-default:#BBBBBB">]) </span><span style="--shiki-default:#FEDE5D">=&gt;</span><span style="--shiki-default:#36F9F6"> C</span><span style="--shiki-default:#BBBBBB">(</span><span style="--shiki-default:#FF7EDB">a</span><span style="--shiki-default:#BBBBBB">, </span><span style="--shiki-default:#FF7EDB">b</span><span style="--shiki-default:#BBBBBB">));
    </span></span><span class="line" line="5"><span style="--shiki-default:#BBBBBB">}
    </span></span></code></pre>
          <h3 id="_3-object-asyncfunction">
            <a href="#_3-object-asyncfunction">3? [object AsyncFunction]</a>
          </h3>
          <p>
            This does not generally strike me as useful, but can theoretically
            come in handy.
          </p>
          <pre
            class="language-ts shiki shiki-themes synthwave-84"
          ><code><span class="line" line="1"><span style="--shiki-default:#FE4450">Object</span><span style="--shiki-default:#BBBBBB">.</span><span style="--shiki-default:#FF7EDB">prototype</span><span style="--shiki-default:#BBBBBB">.</span><span style="--shiki-default:#FF7EDB">toString</span><span style="--shiki-default:#BBBBBB">.</span><span style="--shiki-default:#36F9F6">call</span><span style="--shiki-default:#BBBBBB">(</span><span style="--shiki-default:#FEDE5D">async</span><span style="--shiki-default:#BBBBBB"> () </span><span style="--shiki-default:#FEDE5D">=&gt;</span><span style="--shiki-default:#36F9F6"> producePromise</span><span style="--shiki-default:#BBBBBB">()); </span><span style="--shiki-default:#848BBD;--shiki-default-font-style:italic">// '[object AsyncFunction]'
    </span></span><span class="line" line="2"><span style="--shiki-default:#FE4450">Object</span><span style="--shiki-default:#BBBBBB">.</span><span style="--shiki-default:#FF7EDB">prototype</span><span style="--shiki-default:#BBBBBB">.</span><span style="--shiki-default:#FF7EDB">toString</span><span style="--shiki-default:#BBBBBB">.</span><span style="--shiki-default:#36F9F6">call</span><span style="--shiki-default:#BBBBBB">(() </span><span style="--shiki-default:#FEDE5D">=&gt;</span><span style="--shiki-default:#36F9F6"> producePromise</span><span style="--shiki-default:#BBBBBB">()); </span><span style="--shiki-default:#848BBD;--shiki-default-font-style:italic">// '[object Function]'
    </span></span></code></pre>
          <p>
            So the language gives us a way to know if a function was declared
            with the
            <code class="">async</code> modifier. In some contrived scenario, we
            can imagine that it may be very useful to be able to check during
            runtime if the function will be asynchronous
            <em>before invoking it</em>.
          </p>
          <hr />
          <section class="footnotes" data-footnotes="">
            <h2 id="footnote-label" class="sr-only">
              <a href="#footnote-label">Footnotes</a>
            </h2>
            <ol>
              <li id="user-content-fn-1">
                Composability:
                <code class=""
                  >fetchThing().then(doThing).catch(logError).finally(toFalse)</code
                >
                <a
                  aria-current="page"
                  href="/ok-sometimes-async-await#user-content-fnref-1"
                  class="router-link-active router-link-exact-active data-footnote-backref"
                  aria-label="Back to reference 1"
                  data-footnote-backref=""
                  >â†©</a
                >
              </li>
            </ol>
          </section>
          <style>
            html .default .shiki span {
              color: var(--shiki-default);
              background: var(--shiki-default-bg);
              font-style: var(--shiki-default-font-style);
              font-weight: var(--shiki-default-font-weight);
              text-decoration: var(--shiki-default-text-decoration);
            }

            html .shiki span {
              color: var(--shiki-default);
              background: var(--shiki-default-bg);
              font-style: var(--shiki-default-font-style);
              font-weight: var(--shiki-default-font-weight);
              text-decoration: var(--shiki-default-text-decoration);
            }
          </style>
        </article>
      </main>
    </body>
  </html>
</DOCTYPE>
